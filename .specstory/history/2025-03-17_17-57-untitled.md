## SpecStory

## Untitled (2025. 3. 17. ì˜¤í›„ 5:57:23)

_**User**_

@routers router ì½”ë“œë¥¼ ë¶„ì„í•´ì„œ ê°€ê¸‰ì  routerì—ì„œëŠ” ë¡œì§ì´ ì—†ê³  serviceì—ì„œ ì²˜ë¦¬ë˜ë„ë¡ í•˜ê³  ì‹¶ê³ , ê°€ëŠ¥í•˜ë©´ ê³µí†µ ì½”ë“œëŠ” ë¬¶ì–´ì„œ ì²˜ë¦¬í•˜ê³  ì‹¶ì€ë° ë¶„ì„í•´ì„œ ì²˜ë¦¬í•´ì¤˜

---

_**Assistant**_

ì•ˆë…•í•˜ì„¸ìš”! ë¼ìš°í„° ì½”ë“œë¥¼ ë¶„ì„í•˜ê³  ì„œë¹„ìŠ¤ ê³„ì¸µìœ¼ë¡œ ë¡œì§ì„ ë¶„ë¦¬í•˜ëŠ” ì‘ì—…ì„ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤. ë¨¼ì € í˜„ì¬ ì½”ë“œë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

---

_****_

<details>
            <summary>Listed directory app/services â€¢ **5** results</summary>
        
| Name |
|-------|
| ğŸ“„ `bulletin.py` |
| ğŸ“ `__pycache__` |
| ğŸ“„ `user.py` |
| ğŸ“„ `auth.py` |
| ğŸ“„ `__init__.py` |

</details>

---

_****_

Read file: undefined

---

_****_

Read file: undefined

---

_****_

Read file: undefined

---

_****_

Read file: undefined

---

_****_

Read file: undefined

---

_****_

Read file: undefined

---

_****_

ì´ì œ êµíšŒ ê´€ë ¨ ì„œë¹„ìŠ¤ ê³„ì¸µì„ ë§Œë“¤ê³  ë¼ìš°í„° ì½”ë“œë¥¼ ë¦¬íŒ©í† ë§í•˜ê² ìŠµë‹ˆë‹¤. ë¨¼ì € êµíšŒ ì„œë¹„ìŠ¤ íŒŒì¼ì„ ìƒì„±í•˜ê² ìŠµë‹ˆë‹¤.

---

_****_

```diff
- 
+ from sqlalchemy.orm import Session
+ from sqlalchemy import and_
+ from fastapi import HTTPException, status
+ from typing import List, Optional
+ from datetime import datetime
+ 
+ from app.models import Church, ChurchAdmin
+ from app.models.user import User
+ from app.schemas import ChurchCreate, ChurchUpdate, ChurchCheck
+ 
+ 
+ class ChurchService:
+     """êµíšŒ ê´€ë ¨ ì„œë¹„ìŠ¤ í´ë˜ìŠ¤"""
+ 
+     @staticmethod
+     def get_churches_by_user(
+         db: Session,
+         user_id: int,
+         skip: int = 0,
+         limit: int = 100
+     ) -> List[Church]:
+         """ì‚¬ìš©ìê°€ ê´€ë¦¬í•˜ëŠ” êµíšŒ ëª©ë¡ì„ ë°˜í™˜í•©ë‹ˆë‹¤."""
+         churches = db.query(Church) \
+             .join(ChurchAdmin, Church.id == ChurchAdmin.church_id) \
+             .filter(and_(
+                 Church.is_deleted == 'F',
+                 ChurchAdmin.is_deleted == 'F',
+                 ChurchAdmin.user_id == user_id
+             )).offset(skip).limit(limit).all()
+ 
+         return churches
+ 
+     @staticmethod
+     def create_church(
+         db: Session,
+         church_data: ChurchCreate,
+         user_id: int
+     ) -> Church:
+         """ìƒˆ êµíšŒë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
+         # êµíšŒ ì½”ë“œ ì¤‘ë³µ í™•ì¸
+         db_church = db.query(Church).filter(
+             Church.church_code == church_data.church_code,
+             Church.is_deleted == 'F'
+         ).first()
+ 
+         if db_church:
+             raise HTTPException(
+                 status_code=status.HTTP_400_BAD_REQUEST,
+                 detail="ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ êµíšŒ êµ¬ë¶„ê°’ì…ë‹ˆë‹¤"
+             )
+ 
+         # êµíšŒ ìƒì„±
+         new_church = Church(
+             church_code=church_data.church_code,
+             name=church_data.name,
+             address=church_data.address,
+             contact_info=church_data.contact_info
+         )
+         db.add(new_church)
+         db.flush()
+ 
+         # êµíšŒ ê´€ë¦¬ì ë“±ë¡
+         church_admin = ChurchAdmin(
+             church_id=new_church.id,
+             user_id=user_id
+         )
+         db.add(church_admin)
+         db.commit()
+         db.refresh(new_church)
+ 
+         return new_church
+ 
+     @staticmethod
+     def check_church_code(db: Session, church_code: str) -> ChurchCheck:
+         """êµíšŒ êµ¬ë¶„ê°’ ì¤‘ë³µ í™•ì¸"""
+         db_church = db.query(Church).filter(
+             Church.church_code == church_code,
+             Church.is_deleted == 'F'
+         ).first()
+ 
+         if db_church:
+             return {"available": False, "message": "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ êµíšŒ êµ¬ë¶„ê°’ì…ë‹ˆë‹¤"}
+         return {"available": True, "message": "ì‚¬ìš© ê°€ëŠ¥í•œ êµíšŒ êµ¬ë¶„ê°’ì…ë‹ˆë‹¤"}
+ 
+     @staticmethod
+     def get_church_by_id(db: Session, church_id: int) -> Optional[Church]:
+         """IDë¡œ êµíšŒë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤."""
+         return db.query(Church).filter(
+             Church.id == church_id,
+             Church.is_deleted == 'F'
+         ).first()
+ 
+     @staticmethod
+     def check_church_admin(db: Session, church_id: int, user_id: int) -> bool:
+         """ì‚¬ìš©ìê°€ í•´ë‹¹ êµíšŒì˜ ê´€ë¦¬ìì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤."""
+         is_admin = db.query(ChurchAdmin).filter(
+             ChurchAdmin.church_id == church_id,
+             ChurchAdmin.user_id == user_id,
+             ChurchAdmin.is_deleted == 'F'
+         ).first()
+         return is_admin is not None
+ 
+     @staticmethod
+     def update_church(
+         db: Session,
+         church_id: int,
+         church_data: ChurchUpdate,
+         user_id: int
+     ) -> Church:
+         """êµíšŒ ì •ë³´ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤."""
+         # êµíšŒ ì¡°íšŒ
+         db_church = ChurchService.get_church_by_id(db, church_id)
+         if db_church is None:
+             raise HTTPException(status_code=404, detail="êµíšŒë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
+ 
+         # ê¶Œí•œ í™•ì¸
+         if not ChurchService.check_church_admin(db, church_id, user_id):
+             raise HTTPException(status_code=403, detail="ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤")
+ 
+         # êµíšŒ ì •ë³´ ì—…ë°ì´íŠ¸
+         update_data = church_data.dict(exclude_unset=True)
+         for key, value in update_data.items():
+             setattr(db_church, key, value)
+ 
+         db.commit()
+         db.refresh(db_church)
+         return db_church
+ 
+     @staticmethod
+     def delete_church(db: Session, church_id: int, user_id: int) -> dict:
+         """êµíšŒë¥¼ ì‚­ì œí•©ë‹ˆë‹¤."""
+         # êµíšŒ ì¡°íšŒ
+         db_church = ChurchService.get_church_by_id(db, church_id)
+         if db_church is None:
+             raise HTTPException(status_code=404, detail="êµíšŒë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
+ 
+         # ê¶Œí•œ í™•ì¸
+         if not ChurchService.check_church_admin(db, church_id, user_id):
+             raise HTTPException(status_code=403, detail="ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤")
+ 
+         # êµíšŒ ì‚­ì œ ì²˜ë¦¬ (ì†Œí”„íŠ¸ ì‚­ì œ)
+         db_church.is_deleted = 'T'
+         db_church.deleted_at = datetime.now()
+         db.commit()
+ 
+         return {"detail": "êµíšŒê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤"}
```

---

_****_

```diff
  
  from app.models import Church, ChurchAdmin
- from app.models.user import User
  from app.schemas import ChurchCreate, ChurchUpdate, ChurchCheck
  
```

---

_****_

ì´ì œ ì„œë¹„ìŠ¤ ê³„ì¸µì„ ìƒì„±í–ˆìœ¼ë‹ˆ, ë¼ìš°í„° ì½”ë“œë¥¼ ìˆ˜ì •í•˜ì—¬ ì„œë¹„ìŠ¤ ê³„ì¸µì„ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½í•˜ê² ìŠµë‹ˆë‹¤.

---

_****_

```diff
  from fastapi import APIRouter, Depends, HTTPException, status
  from sqlalchemy.orm import Session
- from sqlalchemy import and_
  from typing import List
- from datetime import datetime
  
  from app import schemas
- from app.models import Church, ChurchAdmin
  from app.db.session import get_db
  from app.models.user import User
  from app.services.auth import AuthService
+ from app.services.church import ChurchService
  
  router = APIRouter()
  ):
      """í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ê´€ë¦¬í•˜ëŠ” êµíšŒ ëª©ë¡ì„ ë°˜í™˜í•©ë‹ˆë‹¤."""
-     # ì‚¬ìš©ìê°€ ê´€ë¦¬í•˜ëŠ” êµíšŒ ID ëª©ë¡ ì¡°íšŒ
-     print(f"current_user: {current_user}")
- 
-     churches = db.query(Church) \
-         .join(ChurchAdmin, Church.id == ChurchAdmin.church_id) \
-         .filter(and_(
-             Church.is_deleted == 'F',
-             ChurchAdmin.is_deleted == 'F',
-             ChurchAdmin.user_id == current_user.id
-         )).offset(skip).limit(limit).all()
- 
-     return churches
- 
-     return churches
+     return ChurchService.get_churches_by_user(db, current_user.id, skip, limit)
  
  
  ):
      """ìƒˆ êµíšŒë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
-     # êµíšŒ ì½”ë“œ ì¤‘ë³µ í™•ì¸
-     db_church = db.query(Church).filter(
-         Church.church_code == church.church_code,
-         Church.is_deleted == 'F'
-     ).first()
- 
-     if db_church:
-         raise HTTPException(
-             status_code=status.HTTP_400_BAD_REQUEST,
-             detail="ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ êµíšŒ êµ¬ë¶„ê°’ì…ë‹ˆë‹¤"
-         )
- 
-     # êµíšŒ ìƒì„±
-     new_church = Church(
-         church_code=church.church_code,
-         name=church.name,
-         address=church.address,
-         contact_info=church.contact_info
-     )
-     db.add(new_church)
-     db.flush()
- 
-     # êµíšŒ ê´€ë¦¬ì ë“±ë¡
-     church_admin = ChurchAdmin(
-         church_id=new_church.id,
-         user_id=current_user.id
-     )
-     db.add(church_admin)
-     db.commit()
-     db.refresh(new_church)
- 
-     return new_church
+     return ChurchService.create_church(db, church, current_user.id)
  
  
  @router.get("/check-code/{church_code}", response_model=schemas.ChurchCheck)
  def check_church_code(church_code: str, db: Session = Depends(get_db)):
      """êµíšŒ êµ¬ë¶„ê°’ ì¤‘ë³µ í™•ì¸"""
-     db_church = db.query(Church).filter(
-         Church.church_code == church_code,
-         Church.is_deleted == 'F'
-     ).first()
- 
-     if db_church:
-         return {"available": False, "message": "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ êµíšŒ êµ¬ë¶„ê°’ì…ë‹ˆë‹¤"}
-     return {"available": True, "message": "ì‚¬ìš© ê°€ëŠ¥í•œ êµíšŒ êµ¬ë¶„ê°’ì…ë‹ˆë‹¤"}
+     return ChurchService.check_church_code(db, church_code)
  
  
      """íŠ¹ì • êµíšŒ ì •ë³´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤."""
      # êµíšŒ ì¡°íšŒ
-     db_church = db.query(Church).filter(
-         Church.id == church_id,
-         Church.is_deleted == 'F'
-     ).first()
- 
+     db_church = ChurchService.get_church_by_id(db, church_id)
      if db_church is None:
          raise HTTPException(status_code=404, detail="êµíšŒë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
  
      # ê¶Œí•œ í™•ì¸
-     is_admin = db.query(ChurchAdmin).filter(
-         ChurchAdmin.church_id == church_id,
-         ChurchAdmin.user_id == current_user.id,
-         ChurchAdmin.is_deleted == 'F'
-     ).first()
- 
-     if not is_admin:
+     if not ChurchService.check_church_admin(db, church_id, current_user.id):
          raise HTTPException(status_code=403, detail="ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤")
  
  ):
      """êµíšŒ ì •ë³´ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤."""
-     # êµíšŒ ì¡°íšŒ
-     db_church = db.query(Church).filter(
-         Church.id == church_id,
-         Church.is_deleted == 'F'
-     ).first()
- 
-     if db_church is None:
-         raise HTTPException(status_code=404, detail="êµíšŒë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
- 
-     # ê¶Œí•œ í™•ì¸
-     is_admin = db.query(ChurchAdmin).filter(
-         ChurchAdmin.church_id == church_id,
-         ChurchAdmin.user_id == current_user.id,
-         ChurchAdmin.is_deleted == 'F'
-     ).first()
- 
-     if not is_admin:
-         raise HTTPException(status_code=403, detail="ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤")
- 
-     # êµíšŒ ì •ë³´ ì—…ë°ì´íŠ¸
-     update_data = church.dict(exclude_unset=True)
-     for key, value in update_data.items():
-         setattr(db_church, key, value)
- 
-     db.commit()
-     db.refresh(db_church)
-     return db_church
+     return ChurchService.update_church(db, church_id, church, current_user.id)
  
  
  ):
      """êµíšŒë¥¼ ì‚­ì œí•©ë‹ˆë‹¤."""
-     # êµíšŒ ì¡°íšŒ
-     db_church = db.query(Church).filter(
-         Church.id == church_id,
-         Church.is_deleted == 'F'
-     ).first()
- 
-     if db_church is None:
-         raise HTTPException(status_code=404, detail="êµíšŒë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
- 
-     # ê¶Œí•œ í™•ì¸
-     is_admin = db.query(ChurchAdmin).filter(
-         ChurchAdmin.church_id == church_id,
-         ChurchAdmin.user_id == current_user.id,
-         ChurchAdmin.is_deleted == 'F'
-     ).first()
- 
-     if not is_admin:
-         raise HTTPException(status_code=403, detail="ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤")
- 
-     # êµíšŒ ì‚­ì œ ì²˜ë¦¬ (ì†Œí”„íŠ¸ ì‚­ì œ)
-     db_church.is_deleted = True
-     db_church.deleted_at = datetime.now()
-     db.commit()
- 
-     return {"detail": "êµíšŒê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤"}
+     return ChurchService.delete_church(db, church_id, current_user.id)
  
```

---

_****_

```diff
- from fastapi import APIRouter, Depends, HTTPException, status
+ from fastapi import APIRouter, Depends, HTTPException
  from sqlalchemy.orm import Session
  from typing import List
```

---

_****_



---



---

